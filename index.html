<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πâ - Natt Wood</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.9); /* ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 15px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        input[type="text"], input[type="number"], input[type="email"], input[type="password"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin: 8px 0 15px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: #f9f9f9;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            margin: 8px 5px 8px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #plot-form label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        
        /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
        .option-group, .sub-options {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            background-color: rgba(240, 240, 240, 0.8);
        }

        /* Results Display */
        .results-display {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #2196F3;
            border-radius: 10px;
            background-color: rgba(33, 150, 243, 0.05);
        }

        .final-result {
            font-size: 1.2em;
            font-weight: bold;
            color: #FF5722;
        }

        /* Dashboard Table */
        #plots-dashboard table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #plots-dashboard th, #plots-dashboard td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #plots-dashboard th {
            background-color: #f2f2f2;
        }

        /* Mobile Responsiveness */
        @media screen and (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 10px;
            }
            input[type="text"], input[type="number"], input[type="email"], input[type="password"] {
                width: 100%;
            }
        }

        .hidden {
            display: none;
        }

        footer {
            text-align: center;
            padding: 10px;
            color: #888;
            font-size: 0.8em;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="login-page" class="container">
        <div class="card login-card">
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πâ</h2>
            <p>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: nattapongkha838@gmail.com (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)</p>
            <input type="email" id="login-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
            <input type="password" id="login-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button onclick="loginUser()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button onclick="registerUser()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            <p id="auth-message" style="color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="dashboard-page" class="container hidden">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤</h1>
            <button onclick="logoutUser()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </header>
        
        <div class="card data-display">
            <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div id="plots-dashboard">
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>

        <div class="card calculation-form">
            <h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="plot-form">
                <p style="font-style: italic; color: #555;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì" ‡∏Å‡πà‡∏≠‡∏ô "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</p>
                
                <label for="plotName">1. ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á:</label>
                <input type="text" id="plotName" required>

                <label for="sellingPrice">2. ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó):</label>
                <input type="number" id="sellingPrice" value="0" step="0.01" required>
                
                <label for="logWeight">3. ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏°‡πâ‡∏ó‡πà‡∏≠‡∏ô (‡∏Å‡∏Å.):</label>
                <input type="number" id="logWeight" value="0" required>
                <label for="fuelWeight">4. ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏°‡πâ‡∏ü‡∏∑‡∏ô (‡∏Å‡∏Å.):</label>
                <input type="number" id="fuelWeight" value="0" required>
                
                <label for="logPrice">5. ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πâ‡∏ó‡πà‡∏≠‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 2.00 ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.):</label>
                <input type="number" id="logPrice" value="2.00" step="0.01" required>
                <label for="fuelPrice">6. ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πâ‡∏ü‡∏∑‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 1.00 ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.):</label>
                <input type="number" id="fuelPrice" value="1.00" step="0.01" required>
                
                <fieldset class="option-group">
                    <legend>7. ‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡πÇ‡∏Ñ‡πà‡∏ô:</legend>
                    <label><input type="radio" name="fallType" value="fall" onchange="toggleFallDetails()" checked> ‡∏•‡πâ‡∏° (‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡πà: 3000 ‡∏ö‡∏≤‡∏ó/‡πÑ‡∏£‡πà)</label>
                    <label><input type="radio" name="fallType" value="chop" onchange="toggleFallDetails()"> ‡πÇ‡∏Ñ‡πà‡∏ô (‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: 0.12 ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)</label>
                </fieldset>
                <div id="fall-details" class="sub-options">
                    <label for="raiAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏£‡πà (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö *‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏°* ‡πÅ‡∏•‡∏∞ *‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà*):</label>
                    <input type="number" id="raiAmount" value="0" step="0.01">
                </div>
                
                <fieldset class="option-group">
                    <legend>8. ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÄ‡∏ú‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏ñ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏ú‡∏≤ ‡πÑ‡∏ñ:</legend>
                    <label><input type="checkbox" name="landManage" value="burn"> ‡πÄ‡∏ú‡∏≤</label>
                    <label><input type="checkbox" name="landManage" value="plow"> ‡πÑ‡∏ñ</label>
                    <label><input type="checkbox" name="landManage" value="none" checked> ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡∏≤/‡πÑ‡∏ñ</label>
                </fieldset>
                <div id="manage-details" class="sub-options">
                    <label for="burnPricePerRai">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏≤ (‡∏ö‡∏≤‡∏ó/‡πÑ‡∏£‡πà):</label>
                    <input type="number" id="burnPricePerRai" value="0" step="0.01">
                    <label for="plowPricePerRai">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ñ (‡∏ö‡∏≤‡∏ó/‡πÑ‡∏£‡πà):</label>
                    <input type="number" id="plowPricePerRai" value="0" step="0.01">
                </div>
                
                <label for="machinePrice">9. ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0.12 ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.‡∏£‡∏ß‡∏°):</label>
                <input type="number" id="machinePrice" value="0.12" step="0.01" required>
                <label for="extinguishPrice">10. ‡∏Ñ‡πà‡∏≤‡∏î‡∏±‡∏ö (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0.06 ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.‡∏£‡∏ß‡∏°):</label>
                <input type="number" id="extinguishPrice" value="0.06" step="0.01" required>
                <label for="clipPrice">11. ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏µ‡∏ö (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0.06 ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.‡∏£‡∏ß‡∏°):</label>
                <input type="number" id="clipPrice" value="0.06" step="0.01" required>
                
                <label for="logTransportPrice">12. ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏°‡πâ‡∏ó‡πà‡∏≠‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0.18 ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.):</label>
                <input type="number" id="logTransportPrice" value="0.18" step="0.01" required>
                <label for="fuelTransportPrice">12. ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏°‡πâ‡∏ü‡∏∑‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 0.15 ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.):</label>
                <input type="number" id="fuelTransportPrice" value="0.15" step="0.01" required>
                
                <label for="brokerFee">13. ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó):</label>
                <input type="number" id="brokerFee" value="0" step="0.01">
                
                <label for="dailyExpenseDays">14. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</label>
                <input type="number" id="dailyExpenseDays" value="0" required>
                <label for="dailyExpenseAmount">14. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô/‡∏ß‡∏±‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 400 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô):</label>
                <input type="number" id="dailyExpenseAmount" value="400" step="0.01" required>

                <button type="button" onclick="calculateAndDisplay()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
                <button type="submit" id="save-button" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>

            <div id="results" class="results-display">
                <h3>üí∞ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:</h3>
                <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πâ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πâ+‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠‡∏Ç‡∏≤‡∏¢): <span id="total-wood-sales">0.00</span> ‡∏ö‡∏≤‡∏ó</p>
                <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ç‡πâ‡∏≠ 7-14): <span id="total-expenses">0.00</span> ‡∏ö‡∏≤‡∏ó</p>
                <p class="final-result">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ (‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô): <span id="final-purchase-price">0.00</span> ‡∏ö‡∏≤‡∏ó</p>
            </div>
        </div>
    </div>

    <footer>
        &copy; Nattapong Khawnuy | ‡∏ô‡∏≤‡∏¢‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏®‡πå ‡∏Ç‡∏≤‡∏ß‡∏ô‡∏∏‡πâ‡∏¢
    </footer>

    <script>
        // --- 3.1 ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCQHC4eKzfx58hRIcoCe_T9-mQ0TP8sdfM",
            authDomain: "natt-wood.firebaseapp.com",
            projectId: "natt-wood",
            storageBucket: "natt-wood.firebasestorage.app",
            messagingSenderId: "933382154771",
            appId: "1:933382154771:web:d3dc315e622fcbb9c7ede6",
            measurementId: "G-HR13T9WFSN"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const ADMIN_EMAIL = 'nattapongkha838@gmail.com';

        // --- 3.2 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Auth ‡πÅ‡∏•‡∏∞ UI Management ---

        function togglePages(showPageId, hidePageId) {
            document.getElementById(showPageId).classList.remove('hidden');
            document.getElementById(hidePageId).classList.add('hidden');
        }

        auth.onAuthStateChanged(user => {
            if (user && user.emailVerified) { // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ Admin ‡∏ï‡πâ‡∏≠‡∏á verify email ‡∏î‡πâ‡∏ß‡∏¢
                togglePages('dashboard-page', 'login-page');
                fetchPlotsData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            } else {
                togglePages('login-page', 'dashboard-page');
            }
        });

        function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const msg = document.getElementById('auth-message');
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    // Check if user is approved (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô Firebase Security Rules/Cloud Functions)
                    // For now, we assume successful login is approved.
                    msg.textContent = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                })
                .catch(error => {
                    msg.textContent = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + error.message;
                });
        }

        function registerUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const msg = document.getElementById('auth-message');

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                    // userCredential.user.sendEmailVerification();
                    msg.textContent = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (" + ADMIN_EMAIL + ")";
                    // ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á user record ‡πÉ‡∏ô Firestore ‡πÅ‡∏•‡∏∞‡∏£‡∏≠ Admin ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 'approved: true'
                    auth.signOut(); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Logout ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                })
                .catch(error => {
                    msg.textContent = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + error.message;
                });
        }

        function logoutUser() {
            auth.signOut().then(() => {
                document.getElementById('auth-message').textContent = "";
            });
        }

        // --- 3.3 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏Å ---
        const FALL_PRICE_PER_RAI = 3000;      // 7. ‡∏•‡πâ‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡πà (‡∏ö‡∏≤‡∏ó/‡πÑ‡∏£‡πà)
        const CHOP_PRICE_PER_KG = 0.12;       // 7. ‡πÇ‡∏Ñ‡πà‡∏ô‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.)
        
        function calculateAndDisplay() {
            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const logWeight = parseFloat(document.getElementById('logWeight').value) || 0;
            const fuelWeight = parseFloat(document.getElementById('fuelWeight').value) || 0;
            const logPrice = parseFloat(document.getElementById('logPrice').value) || 0;
            const fuelPrice = parseFloat(document.getElementById('fuelPrice').value) || 0;
            const sellingPrice = parseFloat(document.getElementById('sellingPrice').value) || 0;

            const fallType = document.querySelector('input[name="fallType"]:checked').value;
            const raiAmount = parseFloat(document.getElementById('raiAmount').value) || 0;

            const burnChecked = document.querySelector('input[name="landManage"][value="burn"]').checked;
            const plowChecked = document.querySelector('input[name="landManage"][value="plow"]').checked;
            const burnPricePerRai = parseFloat(document.getElementById('burnPricePerRai').value) || 0;
            const plowPricePerRai = parseFloat(document.getElementById('plowPricePerRai').value) || 0;
            
            const machinePrice = parseFloat(document.getElementById('machinePrice').value) || 0;
            const extinguishPrice = parseFloat(document.getElementById('extinguishPrice').value) || 0;
            const clipPrice = parseFloat(document.getElementById('clipPrice').value) || 0;
            
            const logTransportPrice = parseFloat(document.getElementById('logTransportPrice').value) || 0;
            const fuelTransportPrice = parseFloat(document.getElementById('fuelTransportPrice').value) || 0;
            const brokerFee = parseFloat(document.getElementById('brokerFee').value) || 0;
            const dailyExpenseDays = parseFloat(document.getElementById('dailyExpenseDays').value) || 0;
            const dailyExpenseAmount = parseFloat(document.getElementById('dailyExpenseAmount').value) || 0;

            const totalWeight = logWeight + fuelWeight;

            // A. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πâ‡πÑ‡∏î‡πâ + ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠‡∏Ç‡∏≤‡∏¢)
            const logSales = logWeight * logPrice;
            const fuelSales = fuelWeight * fuelPrice;
            const totalWoodSales = logSales + fuelSales;
            const totalSales = totalWoodSales + sellingPrice; 

            // B. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ç‡πâ‡∏≠ 7 - 14)

            // 7. ‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏°/‡πÇ‡∏Ñ‡πà‡∏ô
            let fallChopCost = 0;
            if (fallType === 'fall') {
                fallChopCost = raiAmount * FALL_PRICE_PER_RAI; 
            } else if (fallType === 'chop') {
                fallChopCost = totalWeight * CHOP_PRICE_PER_KG; 
            }

            // 8. ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ú‡∏≤/‡πÑ‡∏ñ) - ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡πà
            let manageCost = 0;
            if (burnChecked) {
                manageCost += raiAmount * burnPricePerRai;
            }
            if (plowChecked) {
                manageCost += raiAmount * plowPricePerRai;
            }

            // 9-11. ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏î‡∏±‡∏ö/‡∏Ñ‡∏µ‡∏ö (‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°)
            const machineCost = totalWeight * machinePrice;
            const extinguishCost = totalWeight * extinguishPrice;
            const clipCost = totalWeight * clipPrice;
            
            // 12. ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å
            const transportCost = (logWeight * logTransportPrice) + (fuelWeight * fuelTransportPrice);
            
            // 13. ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤
            const brokerCost = brokerFee;
            
            // 14. ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            const dailyExpenseCost = dailyExpenseDays * dailyExpenseAmount;

            // ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const totalExpenses = fallChopCost + manageCost + machineCost + extinguishCost + clipCost + transportCost + brokerCost + dailyExpenseCost;

            // C. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ
            const finalPurchasePrice = totalSales - totalExpenses;

            // D. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            document.getElementById('total-wood-sales').textContent = totalSales.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('total-expenses').textContent = totalExpenses.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('final-purchase-price').textContent = finalPurchasePrice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à
            document.getElementById('save-button').disabled = false;
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô DOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            const form = document.getElementById('plot-form');
            form.dataset.logSales = logSales.toFixed(2);
            form.dataset.fuelSales = fuelSales.toFixed(2);
            form.dataset.totalSales = totalSales.toFixed(2);
            form.dataset.totalExpenses = totalExpenses.toFixed(2);
            form.dataset.finalPurchasePrice = finalPurchasePrice.toFixed(2);
        }

        // --- 3.4 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase Firestore ---

        document.getElementById('plot-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = e.target;
            const user = auth.currentUser;

            if (!user) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                return;
            }

            const plotData = {
                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á
                plotName: form.plotName.value,
                sellingPrice: parseFloat(form.sellingPrice.value),
                raiAmount: parseFloat(form.raiAmount.value), // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard

                // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤
                logWeight: parseFloat(form.logWeight.value),
                fuelWeight: parseFloat(form.fuelWeight.value),
                logPrice: parseFloat(form.logPrice.value),
                fuelPrice: parseFloat(form.fuelPrice.value),

                // ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                totalSales: parseFloat(form.dataset.totalSales),
                totalExpenses: parseFloat(form.dataset.totalExpenses),
                finalPurchasePrice: parseFloat(form.dataset.finalPurchasePrice),
                
                // Meta Data
                userId: user.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection("plots").add(plotData)
            .then(() => {
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á "${plotData.plotName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                form.reset();
                document.getElementById('save-button').disabled = true;
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Dashboard
                fetchPlotsData(); 
            })
            .catch((error) => {
                console.error("Error adding document: ", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!");
            });
        });

        function fetchPlotsData() {
            const dashboardDiv = document.getElementById('plots-dashboard');
            dashboardDiv.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
            
            db.collection("plots").orderBy("timestamp", "desc").get()
            .then(snapshot => {
                if (snapshot.empty) {
                    dashboardDiv.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏õ‡∏•‡∏á</p>';
                    return;
                }

                let html = '<table><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th><th>‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th><th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th><th>‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)</th></tr></thead><tbody>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const finalPriceColor = data.finalPurchasePrice >= 0 ? 'green' : 'red';
                    
                    const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('th-TH') : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${data.plotName} (${data.raiAmount} ‡πÑ‡∏£‡πà)</td>
                            <td>${date}</td>
                            <td>${data.totalSales.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                            <td>${data.totalExpenses.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                            <td style="font-weight: bold; color: ${finalPriceColor};">${data.finalPurchasePrice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                dashboardDiv.innerHTML = html;
            })
            .catch(error => {
                console.error("Error fetching documents: ", error);
                dashboardDiv.innerHTML = '<p style="color:red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase</p>';
            });
        }
        
        // --- 3.5 Initial Load Function ---
        window.onload = function() {
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            toggleFallDetails(); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏°/‡πÇ‡∏Ñ‡πà‡∏ô
        function toggleFallDetails() {
            const fallType = document.querySelector('input[name="fallType"]:checked').value;
            const raiInput = document.getElementById('raiAmount');
            // raiInput ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô
            // ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            if (fallType === 'chop') {
                 // raiInput.disabled = true; // ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£ disable ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢
            } else {
                 // raiInput.disabled = false;
            }
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Checkbox ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡πÄ‡∏ú‡∏≤/‡πÑ‡∏ñ" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô
        document.querySelectorAll('input[name="landManage"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const isNoneChecked = this.value === 'none' && this.checked;
                const otherCheckboxes = document.querySelectorAll('input[name="landManage"]:not([value="none"])');
                
                if (isNoneChecked) {
                    otherCheckboxes.forEach(cb => cb.checked = false);
                } else if (this.checked) {
                    document.querySelector('input[name="landManage"][value="none"]').checked = false;
                }
            });
        });

    </script>
</body>
</html>
